"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function __awaiter(e,t,r,s){return new(r||(r=Promise))((function(i,a){function o(e){try{l(s.next(e))}catch(e){a(e)}}function n(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(o,n)}l((s=s.apply(e,t||[])).next())}))}Object.defineProperty(exports,"__esModule",{value:!0});var FilterType,has=Object.prototype.hasOwnProperty,isArray=Array.isArray,hexTable=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),compactQueue=function(e){for(;e.length>1;){var t=e.pop(),r=t.obj[t.prop];if(isArray(r)){for(var s=[],i=0;i<r.length;++i)void 0!==r[i]&&s.push(r[i]);t.obj[t.prop]=s}}},arrayToObject=function(e,t){for(var r=t&&t.plainObjects?Object.create(null):{},s=0;s<e.length;++s)void 0!==e[s]&&(r[s]=e[s]);return r},merge=function e(t,r,s){if(!r)return t;if("object"!=typeof r){if(isArray(t))t.push(r);else{if(!t||"object"!=typeof t)return[t,r];(s&&(s.plainObjects||s.allowPrototypes)||!has.call(Object.prototype,r))&&(t[r]=!0)}return t}if(!t||"object"!=typeof t)return[t].concat(r);var i=t;return isArray(t)&&!isArray(r)&&(i=arrayToObject(t,s)),isArray(t)&&isArray(r)?(r.forEach((function(r,i){if(has.call(t,i)){var a=t[i];a&&"object"==typeof a&&r&&"object"==typeof r?t[i]=e(a,r,s):t.push(r)}else t[i]=r})),t):Object.keys(r).reduce((function(t,i){var a=r[i];return has.call(t,i)?t[i]=e(t[i],a,s):t[i]=a,t}),i)},assign=function(e,t){return Object.keys(t).reduce((function(e,r){return e[r]=t[r],e}),e)},decode=function(e,t,r){var s=e.replace(/\+/g," ");if("iso-8859-1"===r)return s.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(s)}catch(e){return s}},encode=function(e,t,r){if(0===e.length)return e;var s=e;if("symbol"==typeof e?s=Symbol.prototype.toString.call(e):"string"!=typeof e&&(s=String(e)),"iso-8859-1"===r)return escape(s).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var i="",a=0;a<s.length;++a){var o=s.charCodeAt(a);45===o||46===o||95===o||126===o||o>=48&&o<=57||o>=65&&o<=90||o>=97&&o<=122?i+=s.charAt(a):o<128?i+=hexTable[o]:o<2048?i+=hexTable[192|o>>6]+hexTable[128|63&o]:o<55296||o>=57344?i+=hexTable[224|o>>12]+hexTable[128|o>>6&63]+hexTable[128|63&o]:(a+=1,o=65536+((1023&o)<<10|1023&s.charCodeAt(a)),i+=hexTable[240|o>>18]+hexTable[128|o>>12&63]+hexTable[128|o>>6&63]+hexTable[128|63&o])}return i},compact=function(e){for(var t=[{obj:{o:e},prop:"o"}],r=[],s=0;s<t.length;++s)for(var i=t[s],a=i.obj[i.prop],o=Object.keys(a),n=0;n<o.length;++n){var l=o[n],u=a[l];"object"==typeof u&&null!==u&&-1===r.indexOf(u)&&(t.push({obj:a,prop:l}),r.push(u))}return compactQueue(t),e},isRegExp=function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},isBuffer=function(e){return!(!e||"object"!=typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},combine=function(e,t){return[].concat(e,t)},utils={arrayToObject:arrayToObject,assign:assign,combine:combine,compact:compact,decode:decode,encode:encode,isBuffer:isBuffer,isRegExp:isRegExp,merge:merge},replace=String.prototype.replace,percentTwenties=/%20/g,Format={RFC1738:"RFC1738",RFC3986:"RFC3986"},formats=utils.assign({default:Format.RFC3986,formatters:{RFC1738:function(e){return replace.call(e,percentTwenties,"+")},RFC3986:function(e){return String(e)}}},Format),has$1=Object.prototype.hasOwnProperty,arrayPrefixGenerators={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},isArray$1=Array.isArray,push=Array.prototype.push,pushToArray=function(e,t){push.apply(e,isArray$1(t)?t:[t])},toISO=Date.prototype.toISOString,defaultFormat=formats.default,defaults={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:utils.encode,encodeValuesOnly:!1,format:defaultFormat,formatter:formats.formatters[defaultFormat],indices:!1,serializeDate:function(e){return toISO.call(e)},skipNulls:!1,strictNullHandling:!1},isNonNullishPrimitive=function(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"symbol"==typeof e||"bigint"==typeof e},stringify=function e(t,r,s,i,a,o,n,l,u,c,p,f,h){var d=t;if("function"==typeof n?d=n(r,d):d instanceof Date?d=c(d):"comma"===s&&isArray$1(d)&&(d=d.join(",")),null===d){if(i)return o&&!f?o(r,defaults.encoder,h,"key"):r;d=""}if(isNonNullishPrimitive(d)||utils.isBuffer(d))return o?[p(f?r:o(r,defaults.encoder,h,"key"))+"="+p(o(d,defaults.encoder,h,"value"))]:[p(r)+"="+p(String(d))];var y,m=[];if(void 0===d)return m;if(isArray$1(n))y=n;else{var g=Object.keys(d);y=l?g.sort(l):g}for(var b=0;b<y.length;++b){var _=y[b];a&&null===d[_]||(isArray$1(d)?pushToArray(m,e(d[_],"function"==typeof s?s(r,_):r,s,i,a,o,n,l,u,c,p,f,h)):pushToArray(m,e(d[_],r+(u?"."+_:"["+_+"]"),s,i,a,o,n,l,u,c,p,f,h)))}return m},normalizeStringifyOptions=function(e){if(!e)return defaults;if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||defaults.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var r=formats.default;if(void 0!==e.format){if(!has$1.call(formats.formatters,e.format))throw new TypeError("Unknown format option provided.");r=e.format}var s=formats.formatters[r],i=defaults.filter;return("function"==typeof e.filter||isArray$1(e.filter))&&(i=e.filter),{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:defaults.addQueryPrefix,allowDots:void 0===e.allowDots?defaults.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:defaults.charsetSentinel,delimiter:void 0===e.delimiter?defaults.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:defaults.encode,encoder:"function"==typeof e.encoder?e.encoder:defaults.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:defaults.encodeValuesOnly,filter:i,formatter:s,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:defaults.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:defaults.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:defaults.strictNullHandling}},stringify_1=function(e,t){var r,s=e,i=normalizeStringifyOptions(t);"function"==typeof i.filter?s=(0,i.filter)("",s):isArray$1(i.filter)&&(r=i.filter);var a,o=[];if("object"!=typeof s||null===s)return"";a=t&&t.arrayFormat in arrayPrefixGenerators?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var n=arrayPrefixGenerators[a];r||(r=Object.keys(s)),i.sort&&r.sort(i.sort);for(var l=0;l<r.length;++l){var u=r[l];i.skipNulls&&null===s[u]||pushToArray(o,stringify(s[u],u,n,i.strictNullHandling,i.skipNulls,i.encode?i.encoder:null,i.filter,i.sort,i.allowDots,i.serializeDate,i.formatter,i.encodeValuesOnly,i.charset))}var c=o.join(i.delimiter),p=!0===i.addQueryPrefix?"?":"";return i.charsetSentinel&&("iso-8859-1"===i.charset?p+="utf8=%26%2310003%3B&":p+="utf8=%E2%9C%93&"),c.length>0?p+c:""},has$2=Object.prototype.hasOwnProperty,defaults$1={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:utils.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},interpretNumericEntities=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},isoSentinel="utf8=%26%2310003%3B",charsetSentinel="utf8=%E2%9C%93",parseValues=function(e,t){var r,s={},i=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,a=t.parameterLimit===1/0?void 0:t.parameterLimit,o=i.split(t.delimiter,a),n=-1,l=t.charset;if(t.charsetSentinel)for(r=0;r<o.length;++r)0===o[r].indexOf("utf8=")&&(o[r]===charsetSentinel?l="utf-8":o[r]===isoSentinel&&(l="iso-8859-1"),n=r,r=o.length);for(r=0;r<o.length;++r)if(r!==n){var u,c,p=o[r],f=p.indexOf("]="),h=-1===f?p.indexOf("="):f+1;-1===h?(u=t.decoder(p,defaults$1.decoder,l,"key"),c=t.strictNullHandling?null:""):(u=t.decoder(p.slice(0,h),defaults$1.decoder,l,"key"),c=t.decoder(p.slice(h+1),defaults$1.decoder,l,"value")),c&&t.interpretNumericEntities&&"iso-8859-1"===l&&(c=interpretNumericEntities(c)),c&&t.comma&&c.indexOf(",")>-1&&(c=c.split(",")),has$2.call(s,u)?s[u]=utils.combine(s[u],c):s[u]=c}return s},parseObject=function(e,t,r){for(var s=t,i=e.length-1;i>=0;--i){var a,o=e[i];if("[]"===o&&r.parseArrays)a=[].concat(s);else{a=r.plainObjects?Object.create(null):{};var n="["===o.charAt(0)&&"]"===o.charAt(o.length-1)?o.slice(1,-1):o,l=parseInt(n,10);r.parseArrays||""!==n?!isNaN(l)&&o!==n&&String(l)===n&&l>=0&&r.parseArrays&&l<=r.arrayLimit?(a=[])[l]=s:a[n]=s:a={0:s}}s=a}return s},parseKeys=function(e,t,r){if(e){var s=r.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,i=/(\[[^[\]]*])/g,a=r.depth>0&&/(\[[^[\]]*])/.exec(s),o=a?s.slice(0,a.index):s,n=[];if(o){if(!r.plainObjects&&has$2.call(Object.prototype,o)&&!r.allowPrototypes)return;n.push(o)}for(var l=0;r.depth>0&&null!==(a=i.exec(s))&&l<r.depth;){if(l+=1,!r.plainObjects&&has$2.call(Object.prototype,a[1].slice(1,-1))&&!r.allowPrototypes)return;n.push(a[1])}return a&&n.push("["+s.slice(a.index)+"]"),parseObject(n,t,r)}},normalizeParseOptions=function(e){if(!e)return defaults$1;if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new Error("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?defaults$1.charset:e.charset;return{allowDots:void 0===e.allowDots?defaults$1.allowDots:!!e.allowDots,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:defaults$1.allowPrototypes,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:defaults$1.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:defaults$1.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:defaults$1.comma,decoder:"function"==typeof e.decoder?e.decoder:defaults$1.decoder,delimiter:"string"==typeof e.delimiter||utils.isRegExp(e.delimiter)?e.delimiter:defaults$1.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:defaults$1.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:defaults$1.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:defaults$1.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:defaults$1.plainObjects,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:defaults$1.strictNullHandling}},parse=function(e,t){var r=normalizeParseOptions(t);if(""===e||null==e)return r.plainObjects?Object.create(null):{};for(var s="string"==typeof e?parseValues(e,r):e,i=r.plainObjects?Object.create(null):{},a=Object.keys(s),o=0;o<a.length;++o){var n=a[o],l=parseKeys(n,s[n],r);i=utils.merge(i,l,r)}return utils.compact(i)},lib={formats:formats,parse:parse,stringify:stringify_1},lib_3=lib.stringify;!function(e){e.EU="eu1",e.US="us1"}(exports.Zone||(exports.Zone={})),function(e){e.ASC="asc",e.DESC="desc"}(exports.DoofinderSorting||(exports.DoofinderSorting={})),function(e){e.Basic="basic",e.OnlyID="onlyid"}(exports.TransformerOptions||(exports.TransformerOptions={})),function(e){e.MatchAnd="match_and",e.MatchOr="match_or",e.Fuzzy="fuzzy",e.PhoneticText="phonetic_text"}(exports.QueryTypes||(exports.QueryTypes={})),function(e){e.Terms="terms",e.Range="range"}(FilterType||(FilterType={}));class DoofinderResult{constructor(e){this._results=[],this._page=1,this._total=null,this._total_found=null,this._max_score=null,this._query=null,this._query_counter=null,this._query_name=null,this._results_per_page=null,this._facets=null,this._filters=null,this._raw=null,e&&this.loadResults(e)}loadFacets(e){this._facets=Object.keys(e).map(t=>({key:e[t]}))}get results(){return this._results}get page(){return this._page}get total(){return this._total}get total_found(){return this._total_found}get max_score(){return this._max_score}get query(){return this._query}get query_counter(){return this._query_counter}get query_name(){return this._query_name}get results_per_page(){return this._results_per_page}get facets(){return this._facets}get filters(){return this._filters}get raw(){return this._raw}loadResults(e){this._raw=e,e.total_found>0?this._results=e.results:this._results=[],this._page=e.page,this._total=e.total,this._total_found=e.total_found,this._max_score=e.max_score,this._query=e.query,this._query_name=e.query_name,this._query_counter=e.query_counter,this._results_per_page=e.results_per_page,e.facets&&this.loadFacets(e.facets),e.filters&&(this._filters=e.filters)}copy(){return new DoofinderResult(this._raw)}}const isArray$2=e=>Array.isArray(e),isObject=e=>"[object Object]"===Object.prototype.toString.call(e),isPlainObject=e=>isObject(e)&&e.constructor===Object&&!e.nodeType&&!e.setInterval,isNotNull=e=>null!=e;class Query{constructor(e){if(this.params={},this.hashid=null,"string"==typeof e)this.hashid=e,this.params.hashid=this.hashid;else if(e instanceof Query){const t=e.getParams();t.query=e.getQuery(),this.params=t}else"object"==typeof e&&(this.params="params"in e?e.params:e)}search(e){this.params.query=e}clear(){this.params={}}setParameter(e,t){if("params"===e)throw new Error("Wrong parameter name!");this.params[e]=t}setParameters(e){this.params=Object.assign({},this.params,e)}addFilter(e,t,r="filter"){let s={};r in this.params&&(s=this.params[r]),s[e]||(s[e]=[]),isPlainObject(t)?s[e]=t:s[e].push(t),this.params[r]=s}removeFilter(e,t,r="filter"){const s=this.params[r];if(s[e]){const i=s[e].indexOf(t);-1!==i&&(s[e].splice(i,1),this.params[r]=s,this.params.page=1)}}hasFilter(e,t,r="filter"){const s=this.params[r]||{};return e in s&&(!t||-1!==s[e].indexOf(t))}toggleFilter(e,t,r="filter"){this.hasFilter(e,t,r)?this.removeFilter(e,t,r):this.addFilter(e,t,r)}setFilters(e,t="filter"){this.params[t]=e,this.params.page=1}addExclusion(e,t){this.addFilter(e,t,"exclude")}removeExclusion(e,t){this.removeFilter(e,t,"exclude")}setExclusions(e){this.setFilters(e,"exclude")}page(e){e?this.setParameter("page",e):delete this.params.page}nextPage(){this.setParameter("page",(this.params.page||1)+1)}resultsPerPage(e){e?this.setParameter("rpp",e):delete this.params.rpp}setTypes(e){e?this.setParameter("type",e):delete this.params.type}addType(e){const t=[];"string"==typeof this.params.type&&t.push(this.params.type),t.push(e),this.setParameter("type",t)}removeType(e){if(this.params.type)if(isArray$2(this.params.type)){const t=this.params.type.indexOf(e);-1!==t&&this.params.type.splice(1,t)}else this.params.type===e&&delete this.params.type}transformer(e){e?this.setParameter("transformer",e):delete this.params.transformer}timeout(e){e?this.setParameter("timeout",e):delete this.params.timeout}jsonp(e){e?this.setParameter("jsonp",e):delete this.params.jsonp}queryName(e){e?this.setParameter("query_name",e):delete this.params.query_name}noStats(e){e&&e?this.setParameter("nostats",1):delete this.params.nostats}hasParameter(e){return e in this.params}getParams(){const e=JSON.parse(JSON.stringify(this.params));return delete e.query,e}getQuery(){return this.params.query}}class ClientRepo{constructor(){this.pool={},this._zone=exports.Zone.EU}static getInstance(){return this.instance||(this.instance=new ClientRepo),this.instance}getClient(){return this.zone in this.pool||(this.pool[this.zone]=new Client(null,{zone:this.zone})),this.pool[this.zone]}set zone(e){this._zone=e}get zone(){return this._zone}}class HttpClient{request(e,t){return __awaiter(this,void 0,void 0,(function*(){if(-1===e.indexOf("http")&&t&&t.host){const r=t.protocol||"http:",s=t.port||"";e=`${r}//${t.host}${s}${e}`}const r=yield fetch(e,t);if(r.ok){return{statusCode:200,data:yield r.json()}}try{const e=yield r.json();return{statusCode:r.status,data:e}}catch(e){return{statusCode:r.status,error:e}}}))}}class Client{constructor(e,t={}){this.apiVersion="5",this.hashid=null,this.httpClient=null,this.version=null,e&&(this.hashid=e);let r,s=null;if("apiKey"in t){if([r,s]=t.apiKey.split("-"),r&&!s)throw new Error("invalid `apiKey`")}else"zone"in t&&(r=t.zone);if(!t.zone&&!t.apiKey)throw new Error("`apiKey` or `zone` must be defined");let[i,a]=(t.address||`${r}-search.doofinder.com`).split("://");isNotNull(a)||(a=i,i=null);const[o,n]=a.split(":");this.requestOptions={host:o,port:n,headers:t.headers||{}},isNotNull(i)&&(this.requestOptions.protocol=`${i}:`),isNotNull(s)&&(this.requestOptions.headers.Authorization=s),"Authorization"in this.requestOptions.headers&&(this.requestOptions.protocol="https:"),this.httpClient=new HttpClient,this.version=`${t.version||this.apiVersion}`}request(e){return __awaiter(this,void 0,void 0,(function*(){return yield this.httpClient.request(e,this.requestOptions)}))}search(e,t,r=!1){return __awaiter(this,void 0,void 0,(function*(){const s=this._buildSearchQueryString(e,t),i=yield this.request(`/${this.version}/search?${s}`);return r&&i.statusCode>=200&&i.statusCode<=299?new DoofinderResult(i.data):i}))}options(e){return __awaiter(this,void 0,void 0,(function*(){return e=e?`?${e}`:"",yield this.request(`/${this.version}/options/${this.hashid}${e}`)}))}stats(e="",t){return __awaiter(this,void 0,void 0,(function*(){const r={hashid:this.hashid,random:(new Date).getTime()};let s=lib_3(Object.assign(r,t||{}));return null!=s&&(s=`?${s}`),yield this.request(`/${this.version}/stats/${e}${s}`)}))}_buildSearchQueryString(e,t){let r=new Query;null==e?(r.search(""),r.setParameters(t||{})):"string"==typeof e?(e=" "===(e=e.replace(/\s+/g," "))?e:e.trim(),r.search(e),r.setParameters(t||{})):r=e,this.hashid&&!r.hasParameter("hashid")&&r.setParameter("hashid",this.hashid);let s=r.getParams();if(s.query=r.getQuery(),isArray$2(s.type)&&1===s.type.length&&(s.type=s.type[0]),isPlainObject(s.sort)&&Object.keys(s.sort).length>1)throw new Error("To sort by multiple fields use an Array of Objects");return lib_3(s,{skipNulls:!1})}}exports.Client=Client,exports.ClientRepo=ClientRepo,exports.DoofinderResult=DoofinderResult,exports.Query=Query;
