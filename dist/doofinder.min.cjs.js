"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function __awaiter(t,e,s,r){return new(s||(s=Promise))((function(i,a){function n(t){try{h(r.next(t))}catch(t){a(t)}}function o(t){try{h(r.throw(t))}catch(t){a(t)}}function h(t){t.done?i(t.value):new s((function(e){e(t.value)})).then(n,o)}h((r=r.apply(t,e||[])).next())}))}function encode(t,e){var s,r,i,a="";for(s in t)if(void 0!==(i=t[s]))if(Array.isArray(i))for(r=0;r<i.length;r++)a&&(a+="&"),a+=encodeURIComponent(s)+"="+encodeURIComponent(i[r]);else a&&(a+="&"),a+=encodeURIComponent(s)+"="+encodeURIComponent(i);return(e||"")+a}var FilterType;Object.defineProperty(exports,"__esModule",{value:!0}),function(t){t.EU="eu1",t.US="us1"}(exports.Zone||(exports.Zone={})),function(t){t.ASC="asc",t.DESC="desc"}(exports.DoofinderSorting||(exports.DoofinderSorting={})),function(t){t.Basic="basic",t.OnlyID="onlyid"}(exports.TransformerOptions||(exports.TransformerOptions={})),function(t){t.MatchAnd="match_and",t.MatchOr="match_or",t.Fuzzy="fuzzy",t.PhoneticText="phonetic_text"}(exports.QueryTypes||(exports.QueryTypes={})),function(t){t.Terms="terms",t.Range="range"}(FilterType||(FilterType={}));class DoofinderResult{constructor(t){this._results=[],this._page=1,this._total=null,this._total_found=null,this._max_score=null,this._query=null,this._query_counter=null,this._query_name=null,this._results_per_page=null,this._facets=null,this._filters=null,this._raw=null,t&&this.loadResults(t)}loadFacets(t){this._facets=Object.keys(t).map(e=>{if(console.log("Loading key",e),"terms"in t[e]){const s=[];t[e].terms.buckets.forEach(t=>{s.push(t)});const r={};return r[e]=s,r}if("range"in t[e]){const s={};return s[e]=t[e].range.buckets[0].stats,s}})}get results(){return this._results}get page(){return this._page}get total(){return this._total}get total_found(){return this._total_found}get max_score(){return this._max_score}get query(){return this._query}get query_counter(){return this._query_counter}get query_name(){return this._query_name}get results_per_page(){return this._results_per_page}get facets(){return this._facets}get filters(){return this._filters}get raw(){return this._raw}loadResults(t){this._raw=t,t.total_found>0?this._results=t.results:this._results=[],this._page=t.page,this._total=t.total,this._total_found=t.total_found,this._max_score=t.max_score,this._query=t.query,this._query_name=t.query_name,this._query_counter=t.query_counter,this._results_per_page=t.results_per_page,t.facets&&this.loadFacets(t.facets),t.filters&&(this._filters=t.filters)}copy(){return new DoofinderResult(this._raw)}}const isArray=t=>Array.isArray(t),isObject=t=>"[object Object]"===Object.prototype.toString.call(t),isPlainObject=t=>isObject(t)&&t.constructor===Object&&!t.nodeType&&!t.setInterval,isNull=t=>!(null!=t);class Query{constructor(t){if(this.params={},this.hashid=null,"string"==typeof t)this.hashid=t,this.params.hashid=this.hashid;else if(t instanceof Query){const e=t.getParams();e.query=t.getQuery(),this.params=e}else"object"==typeof t&&(this.params="params"in t?t.params:t)}search(t){this.params.query=t}clear(){this.params={}}setParameter(t,e){if("params"===t)throw new Error("Wrong parameter name!");this.params[t]=e}setParameters(t){this.params=Object.assign({},this.params,t)}addFilter(t,e,s="filter"){let r={};s in this.params&&(r=this.params[s]),r[t]||(r[t]=[]),isPlainObject(e)?r[t]=e:r[t].push(e),this.params[s]=r,this.params.page=1}removeFilter(t,e,s="filter"){const r=this.params[s];if(r[t]){const i=r[t].indexOf(e);-1!==i&&(r[t].splice(i,1),this.params[s]=r,this.params.page=1)}}hasFilter(t,e,s="filter"){const r=this.params[s]||{};return t in r&&(!e||-1!==r[t].indexOf(e))}toggleFilter(t,e,s="filter"){this.hasFilter(t,e,s)?this.removeFilter(t,e,s):this.addFilter(t,e,s)}setFilters(t,e="filter"){this.params[e]=t,this.params.page=1}addExclusion(t,e){this.addFilter(t,e,"exclude")}removeExclusion(t,e){this.removeFilter(t,e,"exclude")}setExclusions(t){this.setFilters(t,"exclude")}page(t){t?this.setParameter("page",t):delete this.params.page}nextPage(){this.setParameter("page",(this.params.page||1)+1)}resultsPerPage(t){t?this.setParameter("rpp",t):delete this.params.rpp}setTypes(t){t?this.setParameter("type",t):delete this.params.type}addType(t){const e=[];"string"==typeof this.params.type&&e.push(this.params.type),e.push(t),this.setParameter("type",e)}removeType(t){if(this.params.type)if(isArray(this.params.type)){const e=this.params.type.indexOf(t);-1!==e&&this.params.type.splice(1,e)}else this.params.type===t&&delete this.params.type}transformer(t){t?this.setParameter("transformer",t):delete this.params.transformer}timeout(t){t?this.setParameter("timeout",t):delete this.params.timeout}jsonp(t){t?this.setParameter("jsonp",t):delete this.params.jsonp}queryName(t){t?this.setParameter("query_name",t):delete this.params.query_name}noStats(t){t&&t?this.setParameter("nostats",1):delete this.params.nostats}hasParameter(t){return t in this.params}getParams(){const t=JSON.parse(JSON.stringify(this.params));return delete t.query,t}getQuery(){return this.params.query}}class ClientRepo{constructor(){this.pool={},this._zone=exports.Zone.EU}static getInstance(){return this.instance||(this.instance=new ClientRepo),this.instance}getClient(){return this.zone in this.pool||(this.pool[this.zone]=new Client(null,{zone:this.zone})),this.pool[this.zone]}set zone(t){this._zone=t}get zone(){return this._zone}}class HttpClient{request(t,e){return __awaiter(this,void 0,void 0,(function*(){if(-1===t.indexOf("http")&&e&&e.host){const s=e.protocol||"http:",r=e.port||"";t=`${s}//${e.host}${r}${t}`}const s=yield fetch(t,e);if(s.ok){return{statusCode:200,data:yield s.json()}}try{const t=yield s.json();return{statusCode:s.status,data:t}}catch(t){return{statusCode:s.status,error:t}}}))}}class Client{constructor(t,e={}){this.apiVersion="5",this.hashid=null,this.httpClient=null,this.version=null,t&&(this.hashid=t);let s,r=null;if("apiKey"in e){if([s,r]=e.apiKey.split("-"),s&&!r)throw new Error("invalid `apiKey`")}else"zone"in e&&(s=e.zone);if(!e.zone&&!e.apiKey)throw new Error("`apiKey` or `zone` must be defined");let[i,a]=(e.address||`${s}-search.doofinder.com`).split("://");isNull(a)&&(a=i,i=null);const[n,o]=a.split(":");this.requestOptions={host:n,port:o,headers:e.headers||{}},isNull(i)||(this.requestOptions.protocol=`${i}:`),isNull(r)||(this.requestOptions.headers.Authorization=r),"Authorization"in this.requestOptions.headers&&(this.requestOptions.protocol="https:"),this.httpClient=new HttpClient,this.version=`${e.version||this.apiVersion}`}request(t){return __awaiter(this,void 0,void 0,(function*(){return yield this.httpClient.request(t,this.requestOptions)}))}search(t,e,s=!0){return __awaiter(this,void 0,void 0,(function*(){const r=this._buildSearchQueryString(t,e),i=yield this.request(`/${this.version}/search?${r}`);return s&&i.statusCode>=200&&i.statusCode<=299?new DoofinderResult(i.data):i}))}options(t){return __awaiter(this,void 0,void 0,(function*(){return t=t?`?${t}`:"",yield this.request(`/${this.version}/options/${this.hashid}${t}`)}))}stats(t="",e){return __awaiter(this,void 0,void 0,(function*(){const s={hashid:this.hashid,random:(new Date).getTime()};let r=encode(Object.assign(s,e||{}));return null!=r&&(r=`?${r}`),yield this.request(`/${this.version}/stats/${t}${r}`)}))}_buildSearchQueryString(t,e){let s=new Query;null==t?(s.search(""),s.setParameters(e||{})):"string"==typeof t?(t=" "===(t=t.replace(/\s+/g," "))?t:t.trim(),s.search(t),s.setParameters(e||{})):s=t,this.hashid&&!s.hasParameter("hashid")&&s.setParameter("hashid",this.hashid);const r=s.getParams();if(r.query=s.getQuery(),isArray(r.type)&&1===r.type.length&&(r.type=r.type[0]),isPlainObject(r.sort)&&Object.keys(r.sort).length>1)throw new Error("To sort by multiple fields use an Array of Objects");return encode(this._processObjects(r))}_processObjects(t,e){let s={},r="";return e&&(r=""+e),Object.keys(t).forEach(e=>{let i=r.length>0?`${r}[${e}]`:e;if(isArray(t[i])){const r=this._processArray(t[i],e);Object.assign(s,r)}else if(isPlainObject(t[e])){const r=this._processObjects(t[e],e);Object.assign(s,r)}else s[e]=t[e]}),s}_processArray(t,e){let s={};return t.forEach((t,r)=>{if(isArray(t)){const i=this._processArray(t,`${e}[${r}]`);Object.assign(s,i)}else if(isPlainObject(t)){const i=this._processObjects(t,`${e}[${r}]`);Object.assign(s,i)}else s[`${e}[${r}]`]=t}),s}}exports.Client=Client,exports.ClientRepo=ClientRepo,exports.DoofinderResult=DoofinderResult,exports.Query=Query;
