/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function t(t,e,s,r){return new(s||(s=Promise))((function(i,a){function n(t){try{h(r.next(t))}catch(t){a(t)}}function o(t){try{h(r.throw(t))}catch(t){a(t)}}function h(t){t.done?i(t.value):new s((function(e){e(t.value)})).then(n,o)}h((r=r.apply(t,e||[])).next())}))}function e(t,e){var s,r,i,a="";for(s in t)if(void 0!==(i=t[s]))if(Array.isArray(i))for(r=0;r<i.length;r++)a&&(a+="&"),a+=encodeURIComponent(s)+"="+encodeURIComponent(i[r]);else a&&(a+="&"),a+=encodeURIComponent(s)+"="+encodeURIComponent(i);return(e||"")+a}var s,r,i,a,n;!function(t){t.EU="eu1",t.US="us1"}(s||(s={})),function(t){t.ASC="asc",t.DESC="desc"}(r||(r={})),function(t){t.Basic="basic",t.OnlyID="onlyid"}(i||(i={})),function(t){t.MatchAnd="match_and",t.MatchOr="match_or",t.Fuzzy="fuzzy",t.PhoneticText="phonetic_text"}(a||(a={})),function(t){t.Terms="terms",t.Range="range"}(n||(n={}));class o{constructor(t){this._results=[],this._page=1,this._total=null,this._total_found=null,this._max_score=null,this._query=null,this._query_counter=null,this._query_name=null,this._results_per_page=null,this._facets=null,this._filters=null,this._raw=null,t&&this.loadResults(t)}loadFacets(t){this._facets=Object.keys(t).map(e=>{if(console.log("Loading key",e),"terms"in t[e]){const s=[];t[e].terms.buckets.forEach(t=>{s.push(t)});const r={};return r[e]=s,r}if("range"in t[e]){const s={};return s[e]=t[e].range.buckets[0].stats,s}})}get results(){return this._results}get page(){return this._page}get total(){return this._total}get total_found(){return this._total_found}get max_score(){return this._max_score}get query(){return this._query}get query_counter(){return this._query_counter}get query_name(){return this._query_name}get results_per_page(){return this._results_per_page}get facets(){return this._facets}get filters(){return this._filters}get raw(){return this._raw}loadResults(t){this._raw=t,t.total_found>0?this._results=t.results:this._results=[],this._page=t.page,this._total=t.total,this._total_found=t.total_found,this._max_score=t.max_score,this._query=t.query,this._query_name=t.query_name,this._query_counter=t.query_counter,this._results_per_page=t.results_per_page,t.facets&&this.loadFacets(t.facets),t.filters&&(this._filters=t.filters)}copy(){return new o(this._raw)}}const h=t=>Array.isArray(t),u=t=>(t=>"[object Object]"===Object.prototype.toString.call(t))(t)&&t.constructor===Object&&!t.nodeType&&!t.setInterval,l=t=>!(null!=t);class p{constructor(t){if(this.params={},this.hashid=null,"string"==typeof t)this.hashid=t,this.params.hashid=this.hashid;else if(t instanceof p){const e=t.getParams();e.query=t.getQuery(),this.params=e}else"object"==typeof t&&(this.params="params"in t?t.params:t)}search(t){this.params.query=t}clear(){this.params={}}setParameter(t,e){if("params"===t)throw new Error("Wrong parameter name!");this.params[t]=e}setParameters(t){this.params=Object.assign({},this.params,t)}addFilter(t,e,s="filter"){let r={};s in this.params&&(r=this.params[s]),r[t]||(r[t]=[]),u(e)?r[t]=e:r[t].push(e),this.params[s]=r,this.params.page=1}removeFilter(t,e,s="filter"){const r=this.params[s];if(r[t]){const i=r[t].indexOf(e);-1!==i&&(r[t].splice(i,1),this.params[s]=r,this.params.page=1)}}hasFilter(t,e,s="filter"){const r=this.params[s]||{};return t in r&&(!e||-1!==r[t].indexOf(e))}toggleFilter(t,e,s="filter"){this.hasFilter(t,e,s)?this.removeFilter(t,e,s):this.addFilter(t,e,s)}setFilters(t,e="filter"){this.params[e]=t,this.params.page=1}addExclusion(t,e){this.addFilter(t,e,"exclude")}removeExclusion(t,e){this.removeFilter(t,e,"exclude")}setExclusions(t){this.setFilters(t,"exclude")}page(t){t?this.setParameter("page",t):delete this.params.page}nextPage(){this.setParameter("page",(this.params.page||1)+1)}resultsPerPage(t){t?this.setParameter("rpp",t):delete this.params.rpp}setTypes(t){t?this.setParameter("type",t):delete this.params.type}addType(t){const e=[];"string"==typeof this.params.type&&e.push(this.params.type),e.push(t),this.setParameter("type",e)}removeType(t){if(this.params.type)if(h(this.params.type)){const e=this.params.type.indexOf(t);-1!==e&&this.params.type.splice(1,e)}else this.params.type===t&&delete this.params.type}transformer(t){t?this.setParameter("transformer",t):delete this.params.transformer}timeout(t){t?this.setParameter("timeout",t):delete this.params.timeout}jsonp(t){t?this.setParameter("jsonp",t):delete this.params.jsonp}queryName(t){t?this.setParameter("query_name",t):delete this.params.query_name}noStats(t){t&&t?this.setParameter("nostats",1):delete this.params.nostats}hasParameter(t){return t in this.params}getParams(){const t=JSON.parse(JSON.stringify(this.params));return delete t.query,t}getQuery(){return this.params.query}}class c{constructor(){this.pool={},this._zone=s.EU}static getInstance(){return this.instance||(this.instance=new c),this.instance}getClient(){return this.zone in this.pool||(this.pool[this.zone]=new d(null,{zone:this.zone})),this.pool[this.zone]}set zone(t){this._zone=t}get zone(){return this._zone}}class m{request(e,s){return t(this,void 0,void 0,(function*(){if(-1===e.indexOf("http")&&s&&s.host){const t=s.protocol||"http:",r=s.port||"";e=`${t}//${s.host}${r}${e}`}const t=yield fetch(e,s);if(t.ok){return{statusCode:200,data:yield t.json()}}try{const e=yield t.json();return{statusCode:t.status,data:e}}catch(e){return{statusCode:t.status,error:e}}}))}}class d{constructor(t,e={}){this.apiVersion="5",this.hashid=null,this.httpClient=null,this.version=null,t&&(this.hashid=t);let s,r=null;if("apiKey"in e){if([s,r]=e.apiKey.split("-"),s&&!r)throw new Error("invalid `apiKey`")}else"zone"in e&&(s=e.zone);if(!e.zone&&!e.apiKey)throw new Error("`apiKey` or `zone` must be defined");let[i,a]=(e.address||`${s}-search.doofinder.com`).split("://");l(a)&&(a=i,i=null);const[n,o]=a.split(":");this.requestOptions={host:n,port:o,headers:e.headers||{}},l(i)||(this.requestOptions.protocol=`${i}:`),l(r)||(this.requestOptions.headers.Authorization=r),"Authorization"in this.requestOptions.headers&&(this.requestOptions.protocol="https:"),this.httpClient=new m,this.version=`${e.version||this.apiVersion}`}request(e){return t(this,void 0,void 0,(function*(){return yield this.httpClient.request(e,this.requestOptions)}))}search(e,s,r=!0){return t(this,void 0,void 0,(function*(){const t=this._buildSearchQueryString(e,s),i=yield this.request(`/${this.version}/search?${t}`);return r&&i.statusCode>=200&&i.statusCode<=299?new o(i.data):i}))}options(e){return t(this,void 0,void 0,(function*(){return e=e?`?${e}`:"",yield this.request(`/${this.version}/options/${this.hashid}${e}`)}))}stats(s="",r){return t(this,void 0,void 0,(function*(){const t={hashid:this.hashid,random:(new Date).getTime()};let i=e(Object.assign(t,r||{}));return null!=i&&(i=`?${i}`),yield this.request(`/${this.version}/stats/${s}${i}`)}))}_buildSearchQueryString(t,s){let r=new p;null==t?(r.search(""),r.setParameters(s||{})):"string"==typeof t?(t=" "===(t=t.replace(/\s+/g," "))?t:t.trim(),r.search(t),r.setParameters(s||{})):r=t,this.hashid&&!r.hasParameter("hashid")&&r.setParameter("hashid",this.hashid);const i=r.getParams();if(i.query=r.getQuery(),h(i.type)&&1===i.type.length&&(i.type=i.type[0]),u(i.sort)&&Object.keys(i.sort).length>1)throw new Error("To sort by multiple fields use an Array of Objects");return e(this._processObjects(i))}_processObjects(t,e){let s={},r="";return e&&(r=""+e),Object.keys(t).forEach(e=>{let i=r.length>0?`${r}[${e}]`:e;if(h(t[i])){const r=this._processArray(t[i],e);Object.assign(s,r)}else if(u(t[e])){const r=this._processObjects(t[e],e);Object.assign(s,r)}else s[e]=t[e]}),s}_processArray(t,e){let s={};return t.forEach((t,r)=>{if(h(t)){const i=this._processArray(t,`${e}[${r}]`);Object.assign(s,i)}else if(u(t)){const i=this._processObjects(t,`${e}[${r}]`);Object.assign(s,i)}else s[`${e}[${r}]`]=t}),s}}export{d as Client,c as ClientRepo,o as DoofinderResult,r as DoofinderSorting,p as Query,a as QueryTypes,i as TransformerOptions,s as Zone};
