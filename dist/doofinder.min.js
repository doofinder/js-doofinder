/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function t(t,e,r,s){return new(r||(r=Promise))((function(i,n){function o(t){try{l(s.next(t))}catch(t){n(t)}}function a(t){try{l(s.throw(t))}catch(t){n(t)}}function l(t){t.done?i(t.value):new r((function(e){e(t.value)})).then(o,a)}l((s=s.apply(t,e||[])).next())}))}var e,r,s,i,n,o=Object.prototype.hasOwnProperty,a=Array.isArray,l=function(){for(var t=[],e=0;e<256;++e)t.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return t}(),u=function(t,e){for(var r=e&&e.plainObjects?Object.create(null):{},s=0;s<t.length;++s)void 0!==t[s]&&(r[s]=t[s]);return r},c={arrayToObject:u,assign:function(t,e){return Object.keys(e).reduce((function(t,r){return t[r]=e[r],t}),t)},combine:function(t,e){return[].concat(t,e)},compact:function(t){for(var e=[{obj:{o:t},prop:"o"}],r=[],s=0;s<e.length;++s)for(var i=e[s],n=i.obj[i.prop],o=Object.keys(n),l=0;l<o.length;++l){var u=o[l],c=n[u];"object"==typeof c&&null!==c&&-1===r.indexOf(c)&&(e.push({obj:n,prop:u}),r.push(c))}return function(t){for(;t.length>1;){var e=t.pop(),r=e.obj[e.prop];if(a(r)){for(var s=[],i=0;i<r.length;++i)void 0!==r[i]&&s.push(r[i]);e.obj[e.prop]=s}}}(e),t},decode:function(t,e,r){var s=t.replace(/\+/g," ");if("iso-8859-1"===r)return s.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(s)}catch(t){return s}},encode:function(t,e,r){if(0===t.length)return t;var s=t;if("symbol"==typeof t?s=Symbol.prototype.toString.call(t):"string"!=typeof t&&(s=String(t)),"iso-8859-1"===r)return escape(s).replace(/%u[0-9a-f]{4}/gi,(function(t){return"%26%23"+parseInt(t.slice(2),16)+"%3B"}));for(var i="",n=0;n<s.length;++n){var o=s.charCodeAt(n);45===o||46===o||95===o||126===o||o>=48&&o<=57||o>=65&&o<=90||o>=97&&o<=122?i+=s.charAt(n):o<128?i+=l[o]:o<2048?i+=l[192|o>>6]+l[128|63&o]:o<55296||o>=57344?i+=l[224|o>>12]+l[128|o>>6&63]+l[128|63&o]:(n+=1,o=65536+((1023&o)<<10|1023&s.charCodeAt(n)),i+=l[240|o>>18]+l[128|o>>12&63]+l[128|o>>6&63]+l[128|63&o])}return i},isBuffer:function(t){return!(!t||"object"!=typeof t)&&!!(t.constructor&&t.constructor.isBuffer&&t.constructor.isBuffer(t))},isRegExp:function(t){return"[object RegExp]"===Object.prototype.toString.call(t)},merge:function t(e,r,s){if(!r)return e;if("object"!=typeof r){if(a(e))e.push(r);else{if(!e||"object"!=typeof e)return[e,r];(s&&(s.plainObjects||s.allowPrototypes)||!o.call(Object.prototype,r))&&(e[r]=!0)}return e}if(!e||"object"!=typeof e)return[e].concat(r);var i=e;return a(e)&&!a(r)&&(i=u(e,s)),a(e)&&a(r)?(r.forEach((function(r,i){if(o.call(e,i)){var n=e[i];n&&"object"==typeof n&&r&&"object"==typeof r?e[i]=t(n,r,s):e.push(r)}else e[i]=r})),e):Object.keys(r).reduce((function(e,i){var n=r[i];return o.call(e,i)?e[i]=t(e[i],n,s):e[i]=n,e}),i)}},h=String.prototype.replace,p=/%20/g,f={RFC1738:"RFC1738",RFC3986:"RFC3986"},d=c.assign({default:f.RFC3986,formatters:{RFC1738:function(t){return h.call(t,p,"+")},RFC3986:function(t){return String(t)}}},f),y=Object.prototype.hasOwnProperty,m={brackets:function(t){return t+"[]"},comma:"comma",indices:function(t,e){return t+"["+e+"]"},repeat:function(t){return t}},g=Array.isArray,_=Array.prototype.push,v=function(t,e){_.apply(t,g(e)?e:[e])},b=Date.prototype.toISOString,O=d.default,j={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:c.encode,encodeValuesOnly:!1,format:O,formatter:d.formatters[O],indices:!1,serializeDate:function(t){return b.call(t)},skipNulls:!1,strictNullHandling:!1},w=function t(e,r,s,i,n,o,a,l,u,h,p,f,d){var y,m=e;if("function"==typeof a?m=a(r,m):m instanceof Date?m=h(m):"comma"===s&&g(m)&&(m=m.join(",")),null===m){if(i)return o&&!f?o(r,j.encoder,d,"key"):r;m=""}if("string"==typeof(y=m)||"number"==typeof y||"boolean"==typeof y||"symbol"==typeof y||"bigint"==typeof y||c.isBuffer(m))return o?[p(f?r:o(r,j.encoder,d,"key"))+"="+p(o(m,j.encoder,d,"value"))]:[p(r)+"="+p(String(m))];var _,b=[];if(void 0===m)return b;if(g(a))_=a;else{var O=Object.keys(m);_=l?O.sort(l):O}for(var w=0;w<_.length;++w){var q=_[w];n&&null===m[q]||(g(m)?v(b,t(m[q],"function"==typeof s?s(r,q):r,s,i,n,o,a,l,u,h,p,f,d)):v(b,t(m[q],r+(u?"."+q:"["+q+"]"),s,i,n,o,a,l,u,h,p,f,d)))}return b},q=(Object.prototype.hasOwnProperty,function(t,e){var r,s=t,i=function(t){if(!t)return j;if(null!==t.encoder&&void 0!==t.encoder&&"function"!=typeof t.encoder)throw new TypeError("Encoder has to be a function.");var e=t.charset||j.charset;if(void 0!==t.charset&&"utf-8"!==t.charset&&"iso-8859-1"!==t.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var r=d.default;if(void 0!==t.format){if(!y.call(d.formatters,t.format))throw new TypeError("Unknown format option provided.");r=t.format}var s=d.formatters[r],i=j.filter;return("function"==typeof t.filter||g(t.filter))&&(i=t.filter),{addQueryPrefix:"boolean"==typeof t.addQueryPrefix?t.addQueryPrefix:j.addQueryPrefix,allowDots:void 0===t.allowDots?j.allowDots:!!t.allowDots,charset:e,charsetSentinel:"boolean"==typeof t.charsetSentinel?t.charsetSentinel:j.charsetSentinel,delimiter:void 0===t.delimiter?j.delimiter:t.delimiter,encode:"boolean"==typeof t.encode?t.encode:j.encode,encoder:"function"==typeof t.encoder?t.encoder:j.encoder,encodeValuesOnly:"boolean"==typeof t.encodeValuesOnly?t.encodeValuesOnly:j.encodeValuesOnly,filter:i,formatter:s,serializeDate:"function"==typeof t.serializeDate?t.serializeDate:j.serializeDate,skipNulls:"boolean"==typeof t.skipNulls?t.skipNulls:j.skipNulls,sort:"function"==typeof t.sort?t.sort:null,strictNullHandling:"boolean"==typeof t.strictNullHandling?t.strictNullHandling:j.strictNullHandling}}(e);"function"==typeof i.filter?s=(0,i.filter)("",s):g(i.filter)&&(r=i.filter);var n,o=[];if("object"!=typeof s||null===s)return"";n=e&&e.arrayFormat in m?e.arrayFormat:e&&"indices"in e?e.indices?"indices":"repeat":"indices";var a=m[n];r||(r=Object.keys(s)),i.sort&&r.sort(i.sort);for(var l=0;l<r.length;++l){var u=r[l];i.skipNulls&&null===s[u]||v(o,w(s[u],u,a,i.strictNullHandling,i.skipNulls,i.encode?i.encoder:null,i.filter,i.sort,i.allowDots,i.serializeDate,i.formatter,i.encodeValuesOnly,i.charset))}var c=o.join(i.delimiter),h=!0===i.addQueryPrefix?"?":"";return i.charsetSentinel&&("iso-8859-1"===i.charset?h+="utf8=%26%2310003%3B&":h+="utf8=%E2%9C%93&"),c.length>0?h+c:""});!function(t){t.EU="eu1",t.US="us1"}(e||(e={})),function(t){t.ASC="asc",t.DESC="desc"}(r||(r={})),function(t){t.Basic="basic",t.OnlyID="onlyid"}(s||(s={})),function(t){t.MatchAnd="match_and",t.MatchOr="match_or",t.Fuzzy="fuzzy",t.PhoneticText="phonetic_text"}(i||(i={})),function(t){t.Terms="terms",t.Range="range"}(n||(n={}));class P{constructor(t){this._results=[],this._page=1,this._total=null,this._total_found=null,this._max_score=null,this._query=null,this._query_counter=null,this._query_name=null,this._results_per_page=null,this._facets=null,this._filters=null,this._raw=null,t&&this.loadResults(t)}loadFacets(t){this._facets=Object.keys(t).map(e=>({key:t[e]}))}get results(){return this._results}get page(){return this._page}get total(){return this._total}get total_found(){return this._total_found}get max_score(){return this._max_score}get query(){return this._query}get query_counter(){return this._query_counter}get query_name(){return this._query_name}get results_per_page(){return this._results_per_page}get facets(){return this._facets}get filters(){return this._filters}get raw(){return this._raw}loadResults(t){this._raw=t,t.total_found>0?this._results=t.results:this._results=[],this._page=t.page,this._total=t.total,this._total_found=t.total_found,this._max_score=t.max_score,this._query=t.query,this._query_name=t.query_name,this._query_counter=t.query_counter,this._results_per_page=t.results_per_page,t.facets&&this.loadFacets(t.facets),t.filters&&(this._filters=t.filters)}copy(){return new P(this._raw)}}const x=t=>Array.isArray(t),S=t=>(t=>"[object Object]"===Object.prototype.toString.call(t))(t)&&t.constructor===Object&&!t.nodeType&&!t.setInterval,z=t=>null!=t;class F{constructor(t){if(this.params={},this.hashid=null,"string"==typeof t)this.hashid=t,this.params.hashid=this.hashid;else if(t instanceof F){const e=t.getParams();e.query=t.getQuery(),this.params=e}else"object"==typeof t&&(this.params=t)}search(t){this.params.query=t}clear(){this.params={}}setParameter(t,e){if("params"===t)throw new Error("Wrong parameter name!");this.params[t]=e}setParameters(t){this.params=Object.assign({},this.params,t)}addFilter(t,e,r="filter"){const s=this.params[r];s[t]||(s[t]=[]),S(e)?s[t]=e:s[t].push(e),Object.assign(this.params,{filterType:s})}removeFilter(t,e,r="filter"){const s=this.params[r];if(s[t]){const i=s[t].indexOf(e);-1!==i&&(s[t].splice(i,1),this.params[r]=s,this.params.page=1)}}hasFilter(t,e,r="filter"){const s=this.params[r]||{};return t in s&&(!e||-1!==s[t].indexOf(e))}toggleFilter(t,e,r="filter"){this.hasFilter(t,e,r)?this.removeFilter(t,e,r):this.addFilter(t,e,r)}setFilters(t,e="filter"){this.params[e]=t,this.params.page=1}addExclusion(t,e){this.addFilter(t,e,"exclude")}removeExclusion(t,e){this.removeFilter(t,e,"exclude")}setExclusions(t){this.setFilters(t,"exclude")}page(t){t?this.setParameter("page",t):delete this.params.page}nextPage(){this.setParameter("page",(this.params.page||1)+1)}resultsPerPage(t){t?this.setParameter("rpp",t):delete this.params.rpp}setTypes(t){t?this.setParameter("type",t):delete this.params.type}addType(t){const e=[];"string"==typeof this.params.type&&e.push(this.params.type),e.push(t),this.setParameter("type",e)}removeType(t){if(this.params.type)if(x(this.params.type)){const e=this.params.type.indexOf(t);-1!==e&&this.params.type.splice(1,e)}else this.params.type===t&&delete this.params.type}transformer(t){t?this.setParameter("transformer",t):delete this.params.transformer}timeout(t){t?this.setParameter("timeout",t):delete this.params.timeout}jsonp(t){t?this.setParameter("jsonp",t):delete this.params.jsonp}queryName(t){t?this.setParameter("query_name",t):delete this.params.query_name}noStats(t){t&&t?this.setParameter("nostats",1):delete this.params.nostats}hasParameter(t){return t in this.params}getParams(){const t=JSON.parse(JSON.stringify(this.params));return delete t.query,t}getQuery(){return this.params.query}}class k{constructor(){this.pool={},this._zone=e.EU}static getInstance(){return this.instance||(this.instance=new k),this.instance}getClient(){return this.zone in this.pool||(this.pool[this.zone]=new E(null,{zone:this.zone})),this.pool[this.zone]}set zone(t){this._zone=t}get zone(){return this._zone}}class C{request(e,r){return t(this,void 0,void 0,(function*(){if(-1===e.indexOf("http")&&r&&r.host){const t=r.protocol||"http:",s=r.port||"";e=`${t}//${r.host}${s}${e}`}const t=yield fetch(e,r);if(t.ok){return{statusCode:200,data:yield t.json()}}try{const e=yield t.json();return{statusCode:t.status,data:e}}catch(e){return{statusCode:t.status,error:e}}}))}}class E{constructor(t,e={}){this.apiVersion="5",this.hashid=null,this.httpClient=null,this.version=null,t&&(this.hashid=t);let r,s=null;if("apiKey"in e){if([r,s]=e.apiKey.split("-"),r&&!s)throw new Error("invalid `apiKey`")}else"zone"in e&&(r=e.zone);if(!e.zone&&!e.apiKey)throw new Error("`apiKey` or `zone` must be defined");let[i,n]=(e.address||`${r}-search.doofinder.com`).split("://");z(n)||(n=i,i=null);const[o,a]=n.split(":");this.requestOptions={host:o,port:a,headers:e.headers||{}},z(i)&&(this.requestOptions.protocol=`${i}:`),z(s)&&(this.requestOptions.headers.Authorization=s),"Authorization"in this.requestOptions.headers&&(this.requestOptions.protocol="https:"),this.httpClient=new C,this.version=`${e.version||this.apiVersion}`}request(e){return t(this,void 0,void 0,(function*(){return yield this.httpClient.request(e,this.requestOptions)}))}search(e,r,s=!1){return t(this,void 0,void 0,(function*(){const t=this._buildSearchQueryString(e,r),i=yield this.request(`/${this.version}/search?${t}`);return s?new P(i):i}))}options(e){return t(this,void 0,void 0,(function*(){return e=e?`?${e}`:"",yield this.request(`/${this.version}/options/${this.hashid}${e}`)}))}stats(e="",r){return t(this,void 0,void 0,(function*(){const t={hashid:this.hashid,random:(new Date).getTime()};let s=q(Object.assign(t,r||{}));return null!=s&&(s=`?${s}`),yield this.request(`/${this.version}/stats/${e}${s}`)}))}_buildSearchQueryString(t,e){let r=new F;null==t?(r.search(""),r.setParameters(e||{})):"string"==typeof t?(t=" "===(t=t.replace(/\s+/g," "))?t:t.trim(),r.search(t),r.setParameters(e||{})):r=t,this.hashid&&!r.hasParameter("hashid")&&r.setParameter("hashid",this.hashid);let s=r.getParams();if(s.query=r.getQuery(),x(s.type)&&1===s.type.length&&(s.type=s.type[0]),S(s.sort)&&Object.keys(s.sort).length>1)throw new Error("To sort by multiple fields use an Array of Objects");return q(s,{skipNulls:!1})}}export{E as Client,k as ClientRepo,P as DoofinderResult,r as DoofinderSorting,F as Query,i as QueryTypes,s as TransformerOptions,e as Zone};
