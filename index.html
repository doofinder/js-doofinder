<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client</title>

  <link rel="stylesheet" type="text/css" href="dist/doofinder.css">
  <style type="text/css">
    * {
      box-sizing: border-box;
      font-size: 1rem;
      font-family: -apple-system, system-ui, sans-serif;
    }

    body {
      margin: 0;
      padding: 1rem;
    }

    textarea {
      height: 150px;
    }

    #search {
      width: 400px;
      padding: .5rem;
      border: 1px solid #ddd;
    }

    #facets {
      width: 400px;
    }

    .widget {
      margin: 0 0 1rem 0;
    }

    .widget:last-child {
      margin-bottom: 0;
    }

    .df-results {
      width: 400px;
      height: 250px;
      border: 1px solid #ddd;
    }

    .row {
      display: flex;
      flex-flow: row nowrap;
    }

    .col {
      flex: 0 0 auto;
    }

    .col + .col {
      margin-left: 1rem;
    }
  </style>

  <script type="text/javascript" src="dist/doofinder.js"></script>
</head>
<body>
  <input class="widget" id="search" type="text" placeholder="Search something" autofocus="true">
  <!-- <textarea class="widget" id="search" placeholder="Search something"></textarea> -->

  <div class="row" data-hashid="e723b503db15fe242b934df14b141ccc">
    <div class="col">

      <div class="widget df-results" id="results">
        <div class="df-results__content"></div>
      </div>

    </div>
    <div class="col" id="facets">
      <div class="widget" id="price"></div>
    </div>
  </div>

  <script type="text/javascript">

    var $ = doofinder.util.dfdom;
    var bean = doofinder.util.bean;
    var input = new doofinder.widgets.QueryInput('#search');

    var page = $('[data-hashid]');
    var facets = $('#facets');

    var client = new doofinder.Client(page.data('hashid'), 'eu1');
    var controller = new doofinder.Controller(client, [], {rpp: 20});

    client.options(function(err, options){
      controller.registerWidget(input);

      var results = new doofinder.widgets.ScrollDisplay("#results");
      results.on("df:widget:render", function(res){
        console.log("[df:widget:render][" + res.hashid + "] query: '" + res.query + "' page: " + res.page);
      });
      controller.registerWidget(results);

      options.facets.forEach(function(facet){
        if (facet.type === 'terms') {
          controller.registerWidget(
            new doofinder.widgets.CollapsiblePanel(
              facets,
              function(panel){
                var widget = new doofinder.widgets.TermsFacet(
                  panel.contentElement,
                  facet.name,
                  {
                    size: facet.size,
                    label: facet.label
                  }
                );

                widget.on("df:widget:render", function(res){
                  var html = [facet.label];
                  var total = this.countSelectedTerms(res);

                  if (total > 0) {
                    html.push('(' + total + ')');
                  }

                  panel.labelElement.html(html.join(' '));
                  console.log("[df:widget:render][" + facet.name + "]");
                });

                return widget;
              },
              {
                insertionMethod: "prepend",
                startCollapsed: facet.name === 'categories',
                templateVars: {
                  label: facet.label
                }
              }
            )
          );
        } else {
          controller.registerWidget(
            new doofinder.widgets.RangeFacet($('#price'), facet.name)
          );
        }
      });
    });

    input.on("df:input:stop", function(query){
      console.log("[df:input:stop] " + query);
    });

  </script>
</body>
</html>
